name: ğŸ“ˆ Version Release & Changelog Update

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v2.1.0)'
        required: true
        type: string
      release_notes:
        description: 'Release notes summary'
        required: false
        type: string

env:
  NODE_VERSION: '18.x'
  PNPM_VERSION: '10.x'

jobs:
  release:
    name: ğŸš€ Create Release & Update Changelog
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“‹ Get package info
        id: package
        run: |
          echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
          echo "name=$(node -p "require('./package.json').name")" >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "tag=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ Generate changelog entry
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DATE=$(date +"%Y-%m-%d")
          RELEASE_NOTES="${{ github.event.inputs.release_notes }}"
          
          # Create changelog entry
          cat > changelog_entry.md << EOF
          ## ğŸš€ [${VERSION}] - ${DATE}
          
          ### âœ¨ æ–°å¢åŠŸèƒ½
          ${RELEASE_NOTES:-"- ç‰ˆæœ¬æ›´æ–°å’Œä¼˜åŒ–æ”¹è¿›"}
          
          ### ğŸ”§ æŠ€æœ¯æ”¹è¿›
          - ä¾èµ–åŒ…æ›´æ–°å’Œå®‰å…¨ä¿®å¤
          - æ€§èƒ½ä¼˜åŒ–å’Œä»£ç è´¨é‡æå‡
          
          ### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
          - å‘å¸ƒæ—¶é—´: ${DATE}
          - ç‰ˆæœ¬æ ‡ç­¾: ${VERSION}
          - æäº¤å“ˆå¸Œ: ${GITHUB_SHA:0:7}
          
          ---
          
          EOF

      - name: ğŸ“„ Update CHANGELOG.md
        run: |
          # Backup original changelog
          cp CHANGELOG.md CHANGELOG.md.backup
          
          # Insert new entry after the first "---" line
          awk '
            BEGIN { found = 0 }
            /^---$/ && found == 0 { 
              print $0
              print ""
              while ((getline line < "changelog_entry.md") > 0) {
                print line
              }
              close("changelog_entry.md")
              found = 1
              next
            }
            { print }
          ' CHANGELOG.md.backup > CHANGELOG.md

      - name: ğŸ“Š Update version statistics
        run: |
          # Count files and lines
          FILES_COUNT=$(find . -name "*.ts" -o -name "*.tsx" -o -name "*.astro" -o -name "*.md" | wc -l)
          LINES_COUNT=$(find . -name "*.ts" -o -name "*.tsx" -o -name "*.astro" -o -name "*.md" -exec wc -l {} + | tail -1 | awk '{print $1}')
          
          echo "ğŸ“Š Project Statistics:"
          echo "- Files: $FILES_COUNT"
          echo "- Lines: $LINES_COUNT"
          echo "- Version: ${{ steps.version.outputs.version }}"

      - name: ğŸ”§ Build and test
        run: |
          pnpm install --frozen-lockfile
          pnpm run build
          echo "âœ… Build successful"

      - name: ğŸ“¤ Commit changelog updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [[ -n $(git diff --name-only) ]]; then
            git add CHANGELOG.md
            git commit -m "docs: update CHANGELOG for ${{ steps.version.outputs.version }}"
            git push
            echo "âœ… Changelog updated and committed"
          else
            echo "â„¹ï¸ No changes to commit"
          fi

      - name: ğŸ·ï¸ Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          release_name: "ğŸ‰ SilentX ${{ steps.version.outputs.version }}"
          body_path: changelog_entry.md
          draft: false
          prerelease: false

      - name: ğŸ“¢ Release notification
        run: |
          echo "ğŸ‰ Release ${{ steps.version.outputs.version }} created successfully!"
          echo "ğŸ“‹ Changelog updated with new version"
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"

  update-readme:
    name: ğŸ“ Update README version info
    needs: release
    runs-on: ubuntu-latest
    if: always() && needs.release.result == 'success'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”„ Update README version badge
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          DATE=$(date +"%Y-%m-%d")
          
          # Update version in README.md
          sed -i "s/v[0-9]\+\.[0-9]\+\.[0-9]\+ ([0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\})/v${VERSION} (${DATE})/g" README.md
          
          # Update "æœ€æ–°" status in version table
          sed -i "s/\*\*v[0-9]\+\.[0-9]\+\.[0-9]\+\*\*/v${VERSION}/g" README.md
          sed -i "s/| v[0-9]\+\.[0-9]\+\.[0-9]\+ |/| **v${VERSION}** |/g" README.md

      - name: ğŸ“¤ Commit README updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [[ -n $(git diff --name-only) ]]; then
            git add README.md
            git commit -m "docs: update README version info for ${{ needs.release.outputs.version }}"
            git push
            echo "âœ… README updated with new version"
          else
            echo "â„¹ï¸ No README changes to commit"
          fi

  notify:
    name: ğŸ“¢ Notify release completion
    needs: [release, update-readme]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ‰ Success notification
        if: needs.release.result == 'success'
        run: |
          echo "ğŸ‰ ç‰ˆæœ¬å‘å¸ƒæˆåŠŸå®Œæˆï¼"
          echo "âœ… CHANGELOG.md å·²æ›´æ–°"
          echo "âœ… GitHub Release å·²åˆ›å»º"
          echo "âœ… README.md ç‰ˆæœ¬ä¿¡æ¯å·²æ›´æ–°"
          echo ""
          echo "ğŸ”— æŸ¥çœ‹å‘å¸ƒ: https://github.com/${{ github.repository }}/releases"
          echo "ğŸ“‹ æŸ¥çœ‹æ›´æ–°æ—¥å¿—: https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md"

      - name: âŒ Failure notification
        if: needs.release.result == 'failure'
        run: |
          echo "âŒ ç‰ˆæœ¬å‘å¸ƒè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯"
          echo "è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯"
          echo "ğŸ” æ—¥å¿—åœ°å€: https://github.com/${{ github.repository }}/actions"